name: Deploy Live Site (main -> gh-pages)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: deploy-live
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main (site source)
        uses: actions/checkout@v4
        with:
          path: src

      - name: Checkout gh-pages (published branch)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: pages
        continue-on-error: true

      - name: Initialize gh-pages if missing
        run: |
          if [ ! -d "pages/.git" ]; then
            mkdir -p pages
            cd pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://github.com/${GITHUB_REPOSITORY}.git"
          fi

      - name: Sync site into gh-pages root (preserve pr/ and CNAME)
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

          # Ensure we keep PR previews and custom domain files
          mkdir -p pages/pr

          # Copy from src/ -> pages/ root, deleting old live files,
          # but preserving pr/ and CNAME (and .nojekyll if you rely on it)
          rsync -av --delete \
            --exclude "pr/" \
            --exclude "CNAME" \
            --exclude ".nojekyll" \
            --exclude ".git/" \
            "src/" "pages/"

          # Make sure custom domain is preserved (use your existing CNAME from main)
          if [ -f "src/CNAME" ]; then
            cp "src/CNAME" "pages/CNAME"
          fi
          # If you use .nojekyll in main, preserve it too
          if [ -f "src/.nojekyll" ]; then
            cp "src/.nojekyll" "pages/.nojekyll"
          fi

      - name: Commit and push
        run: |
          cd pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Deploy live site from main" || exit 0
          git pull --rebase origin gh-pages
          git push -u origin gh-pages
